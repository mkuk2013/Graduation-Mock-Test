<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IBA Graduation Mock Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- Base Variables & Reset --- */
        :root {
            /* Light Mode Colors - Professional Palette */
            --primary-color: #007bff; /* IBM Blue - Main actions, header */
            --primary-dark: #0056b3;
            --secondary-color: #6c757d; /* Muted Grey - Secondary actions */
            --secondary-dark: #5a6268;
            --accent-color: #28a745; /* Success Green - Correct, answered, progress */
            --accent-dark: #218838;
            --warning-color: #ffc107; /* Caution Yellow - Not attempted, flagged */
            --danger-color: #dc3545; /* Error Red - Incorrect, time low */

            --text-color: #343a40; /* Dark Grey - Main text */
            --light-text-color: #6c757d; /* Muted Grey - Sub-text, placeholders */
            --bg-color: #f0f2f5; /* Light Grey - Overall background */
            --card-bg: #ffffff; /* Pure White - Card backgrounds */
            --border-color: #e0e6ed; /* Light Blue-Grey - Borders */
            --shadow: 0 6px 20px rgba(0, 0, 0, 0.08); /* Soft, diffused shadow */
            --border-radius: 12px;
            --input-bg: #ffffff;
            --hover-bg-light: rgba(0, 0, 0, 0.03);

            /* Calculator/Scratchpad - ADJUSTED FOR IMAGE LAYOUT */
            --calc-bg: #4c4c4c; /* Darker background for calculator body */
            --calc-border: #333;
            --calc-btn-bg: #808080; /* Grey buttons */
            --calc-btn-hover: #999999;
            --calc-btn-operator-bg: #f2a22c; /* Orange operator buttons */
            --calc-btn-operator-hover: #e09428;
            --calc-btn-clear-bg: #666666; /* Specific color for AC, +/-, % */
            --calc-btn-clear-hover: #777777;
            --calc-display-bg: #333333; /* Dark display background */
            --calc-display-text: white; /* White text on dark display */
            --scratchpad-bg: #fcfcfc;
            --scratchpad-border: #d0d0d0;
        }

        /* Dark Mode Variables - Professional Palette */
        body.dark-mode {
            --primary-color: #7abaff; /* Lighter Blue - Main actions, header */
            --primary-dark: #5c9ceb;
            --secondary-color: #adb5bd; /* Lighter Grey - Secondary actions */
            --secondary-dark: #9da7b3;
            --accent-color: #4cd180; /* Brighter Green - Correct, answered, progress */
            --accent-dark: #3aa86a;
            --warning-color: #ffc107; /* Keep Yellow */
            --danger-color: #ff6b6b; /* Softer Red */

            --text-color: #e0e6ed; /* Light Blue-Grey - Main text */
            --light-text-color: #adb5bd; /* Muted Light Grey - Sub-text, placeholders */
            --bg-color: #2c3e50; /* Dark Blue-Grey - Overall background */
            --card-bg: #34495e; /* Darker Blue-Grey - Card backgrounds */
            --border-color: #4a657e; /* Slightly Lighter Dark Blue-Grey - Borders */
            --shadow: 0 6px 20px rgba(0, 0, 0, 0.25); /* More prominent shadow */
            --input-bg: #4a657e;
            --hover-bg-light: rgba(255, 255, 255, 0.08);

            /* Calculator/Scratchpad Dark Mode - Match overall dark theme, keep calc distinct */
            --calc-bg: #4c4c4c; /* Keep dark calc background for consistency with image */
            --calc-border: #333;
            --calc-btn-bg: #808080;
            --calc-btn-hover: #999999;
            --calc-btn-operator-bg: #f2a22c;
            --calc-btn-operator-hover: #e09428;
            --calc-btn-clear-bg: #666666;
            --calc-btn-clear-hover: #777777;
            --calc-display-bg: #333333;
            --calc-display-text: white;
            --scratchpad-bg: #213547;
            --scratchpad-border: #4a657e;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: background-color 0.4s ease, color 0.4s ease;
            overflow-x: hidden;
            font-size: 16px;
        }

        /* --- Global Header & Footer --- */
        .page-header {
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            padding: 15px 30px;
            text-align: center;
            font-weight: 600;
            font-size: 1.3em;
            box-shadow: var(--shadow);
            flex-shrink: 0;
            z-index: 100; /* Ensure it's above everything */
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        .page-header h1 {
            font-size: 1.3em;
            margin: 0;
            flex-grow: 1;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .mode-toggle {
            cursor: pointer;
            font-size: 1.6em;
            color: white;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s, transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mode-toggle:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        .mode-toggle i {
            pointer-events: none;
        }
        .page-footer {
            font-size: 0.85em;
            padding: 12px 20px;
            margin-top: auto;
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .page-footer a {
            color: inherit;
            text-decoration: none;
            font-weight: 500;
        }
        .page-footer a:hover {
            text-decoration: underline;
        }

        /* --- Main Container --- */
        .container {
            width: 100%;
            max-width: 1000px; /* Wider container for more content */
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin: 25px auto;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        /* --- Common Screen Styling --- */
        .screen {
            padding: 40px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .screen h2 {
            margin-bottom: 25px;
            font-size: 2.2em;
            color: var(--primary-color);
            font-weight: 700;
        }
        .screen p {
            font-size: 1.1em;
            color: var(--light-text-color);
            margin-bottom: 30px;
            line-height: 1.6;
        }

        /* --- Password Screen --- */
        #password-screen .input-group {
            position: relative;
            margin-bottom: 25px;
            width: 85%;
            max-width: 400px;
        }
        #password-input {
            width: 100%;
            padding: 14px 45px 14px 20px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1.1em;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: border-color 0.3s, background-color 0.3s, box-shadow 0.3s;
        }
        #password-input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.25);
        }
        .toggle-password {
            position: absolute;
            right: 18px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--light-text-color);
            font-size: 1.1em;
            transition: color 0.2s;
        }
        .toggle-password:hover {
            color: var(--text-color);
        }

        /* --- Instructions Screen --- */
        #instructions-screen {
            text-align: left;
        }
        #instructions-screen ul {
            list-style: disc;
            margin-left: 25px;
            margin-bottom: 30px;
            color: var(--text-color);
        }
        #instructions-screen ul li {
            margin-bottom: 10px;
            font-size: 1.05em;
            line-height: 1.5;
        }
        #instructions-screen .btn {
            margin-top: 20px;
        }

        /* --- Test Screen Layout --- */
        #test-screen {
            padding: 0;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 30px;
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 15px;
        }
        #question-counter, #timer {
            font-weight: 600;
            font-size: 1.15em;
            background-color: var(--primary-color);
            color: white;
            padding: 10px 18px;
            border-radius: 30px;
            min-width: 140px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s;
        }
        #timer.time-low {
            background-color: var(--danger-color);
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            background-color: var(--border-color);
            height: 10px;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--accent-color);
            border-radius: 5px;
            transition: width 0.4s ease-out;
        }

        .test-body {
            padding: 30px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        #question-container {
            font-size: 1.4em;
            margin-bottom: 30px;
            line-height: 1.6;
            font-weight: 500;
            color: var(--text-color);
        }
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .option {
            padding: 16px 22px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, transform 0.1s, box-shadow 0.2s;
            font-size: 1.15em;
            text-align: left;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        .option:hover {
            background-color: var(--hover-bg-light);
            border-color: var(--primary-color);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.05);
        }
        .option.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        body.dark-mode .option.selected {
            color: var(--card-bg); /* White text on selected option in dark mode */
        }

        .test-footer {
            display: flex;
            justify-content: space-between;
            align-items: center; /* Align items vertically */
            padding: 25px 30px;
            border-top: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 20px;
            background-color: var(--bg-color);
        }
        .test-footer .left-controls, .test-footer .right-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* Jump to Question */
        .jump-to-question {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-color);
            font-weight: 500;
        }
        .jump-to-question select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 1em;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .jump-to-question select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        /* Flag Button */
        .btn-flag {
            background-color: transparent;
            color: var(--light-text-color);
            border: 1px solid var(--border-color);
            padding: 10px 15px;
            font-size: 0.95em;
            box-shadow: none;
        }
        .btn-flag:hover {
            background-color: var(--hover-bg-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .btn-flag.flagged {
            background-color: var(--warning-color);
            color: var(--text-color); /* Dark text on yellow for contrast */
            border-color: var(--warning-color);
            box-shadow: 0 2px 5px rgba(255,193,7,0.3);
        }
        body.dark-mode .btn-flag.flagged {
            color: #333; /* Dark text on orange in dark mode */
        }

        /* --- Question Palette --- */
       #question-palette {
    display: flex; /* Changed from grid to flex */
    flex-wrap: nowrap; /* Ensures all buttons stay in one row */
    overflow-x: auto; /* Enables horizontal scrolling */
    gap: 12px;
    padding: 25px 30px;
    border-top: 1px solid var(--border-color);
    background-color: var(--bg-color);
    /* Remove grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); */
}

.palette-btn {
    width: 50px;
    height: 50px;
    flex-shrink: 0; /* Prevents buttons from shrinking */
    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: var(--border-radius);
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
    cursor: pointer;
    font-weight: 500;
    transition: background-color 0.2s, border-color 0.2s, transform 0.1s, box-shadow 0.2s;
    color: var(--text-color);
    font-size: 1.05em;
}
        .palette-btn:hover {
            background-color: var(--hover-bg-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .palette-btn.current {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 3px 10px rgba(0,0,0,0.25);
            transform: scale(1.05);
        }
        .palette-btn.answered {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        .palette-btn.not-answered {
            background-color: var(--warning-color);
            color: var(--text-color);
            border-color: var(--warning-color);
        }
        body.dark-mode .palette-btn.not-answered {
            color: #333;
        }
        .palette-btn.flagged {
            position: relative;
            box-shadow: 0 0 0 3px var(--danger-color); /* Red border for flagged */
        }
        .palette-btn.flagged::after {
            content: '\f024'; /* Flag icon */
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.7em;
            color: var(--danger-color);
            background-color: var(--card-bg);
            border-radius: 50%;
            padding: 2px;
            line-height: 1;
        }
        body.dark-mode .palette-btn.flagged::after {
            background-color: var(--card-bg);
        }


        /* --- Result Screen --- */
        #result-screen {
            padding: 40px;
            text-align: center;
        }
        #result-summary {
            margin-bottom: 40px;
            padding: 30px;
            border-radius: var(--border-radius);
            background-color: var(--bg-color);
            box-shadow: inset 0 0 15px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }
        #result-summary h2 {
            margin-top: 0;
            color: var(--primary-color);
        }
        .score-circle {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--accent-color), var(--accent-dark));
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: auto;
            margin-bottom: 25px;
            font-weight: 600;
            box-shadow: var(--shadow);
        }
        .score-circle span:first-child {
            font-size: 4em;
            font-weight: 700;
        }
        .score-circle span:last-child {
            font-size: 1.2em;
        }
        .score-details {
            display: flex;
            justify-content: space-around;
            margin-top: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        .score-details div {
            flex-basis: 48%;
            padding: 15px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }
        .score-details p {
            margin: 0;
            font-size: 1.05em;
        }
        .score-details p:first-child {
            color: var(--light-text-color);
            font-weight: 500;
            margin-bottom: 5px;
        }
        .score-details p:last-child {
            font-weight: 600;
            font-size: 1.2em;
        }


        .result-question {
            margin-bottom: 25px;
            padding: 20px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            text-align: left;
            background-color: var(--card-bg);
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }
        .result-question p {
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 1.1em;
            line-height: 1.5;
            color: var(--text-color);
        }
        .result-option {
            margin-left: 25px;
            margin-bottom: 8px;
            font-size: 1em;
            color: var(--light-text-color);
        }
        .correct {
            color: var(--accent-color);
            font-weight: 600;
        }
        .incorrect {
            color: var(--danger-color);
        }
        .user-answer.correct::before {
            content: '✓ Your Answer: ';
            color: var(--accent-color);
            font-weight: 600;
        }
        .user-answer.incorrect::before {
            content: '✗ Your Answer: ';
            color: var(--danger-color);
            font-weight: 600;
        }
        .not-attempted-text {
            color: var(--light-text-color);
            font-style: italic;
            margin-left: 25px;
            margin-top: 10px;
        }

        /* --- Buttons --- */
        .btn {
            padding: 14px 35px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 600;
            transition: all 0.25s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: none;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        .btn-secondary:hover {
            background-color: var(--secondary-dark);
        }

        /* Result screen controls */
        #result-screen .controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            padding: 0 20px;
        }

        /* --- Modals (Confirmation Popups) --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: var(--card-bg);
            padding: 40px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
            text-align: center;
            position: relative;
            animation: fadeIn 0.4s ease-out;
            border: 1px solid var(--border-color);
        }
        .modal-content h3 {
            margin-bottom: 25px;
            color: var(--primary-color);
            font-size: 1.8em;
            font-weight: 700;
        }
        .modal-content p {
            font-size: 1.1em;
            line-height: 1.5;
            color: var(--text-color);
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-40px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* Review Summary Modal */
        #review-summary-modal .modal-content {
            max-width: 700px;
            text-align: left;
        }
        #review-summary-modal h3 {
            text-align: center;
        }
        #review-summary-modal .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        #review-summary-modal .summary-item {
            background-color: var(--bg-color);
            padding: 15px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            text-align: center;
        }
        #review-summary-modal .summary-item strong {
            display: block;
            font-size: 1.5em;
            margin-bottom: 5px;
            color: var(--primary-color);
        }
        #review-summary-modal .summary-item span {
            color: var(--light-text-color);
            font-size: 0.95em;
        }
        #review-summary-modal .summary-item.answered strong {
            color: var(--accent-color);
        }
        #review-summary-modal .summary-item.not-answered strong {
            color: var(--warning-color);
        }
        #review-summary-modal .summary-item.flagged strong {
            color: var(--danger-color);
        }

        /* --- Utility Classes --- */
        .hidden {
            display: none !important;
        }
        .flex-center {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- Loading Spinner --- */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.85);
            z-index: 2000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.3em;
            backdrop-filter: blur(8px);
        }
        .spinner {
            border: 8px solid rgba(255,255,255,0.2);
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            width: 70px;
            height: 70px;
            animation: spin 1s linear infinite;
            margin-bottom: 25px;
        }
        #loading-overlay p {
            color: white;
            font-weight: 500;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Floating Tools (Calculator & Scratchpad) --- */
        .floating-tool-trigger {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary-color);
            color: white;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8em;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: background-color 0.3s, transform 0.3s;
            z-index: 999; /* Below modals, above test content */
        }
        .floating-tool-trigger:hover {
            background-color: var(--primary-dark);
            transform: scale(1.05);
        }
        .floating-tool-container {
            position: fixed;
            background-color: var(--calc-bg); /* Use calc-bg */
            border: 1px solid var(--calc-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 998;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 0;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: grab;
        }
        .floating-tool-container.hidden {
            display: none !important;
        }
        .floating-tool-header {
            background-color: var(--calc-display-bg); /* Darker header like display */
            color: var(--calc-display-text);
            padding: 10px 15px;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            font-size: 1.1em;
            cursor: grab;
        }
        .floating-tool-header .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s;
        }
        .floating-tool-header .close-btn:hover {
            transform: scale(1.2);
        }

        /* Calculator Specific Styles - REVISED FOR IMAGE LAYOUT */
        #calculator-tool {
            width: 320px; /* Fixed width as per common calculator layouts */
            height: 500px; /* Adjusted height for 5 rows of buttons + display */
            min-width: 320px;
            min-height: 480px;
            resize: none;
            border-radius: 20px; /* More rounded corners for the calculator body */
            overflow: hidden;
        }

        #calculator {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #calculator .display {
            background-color: var(--calc-display-bg);
            color: var(--calc-display-text);
            font-size: 3.5em; /* Larger font for display */
            text-align: right;
            padding: 20px;
            flex-shrink: 0; /* Don't shrink the display */
            overflow-x: auto;
            white-space: nowrap;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) transparent;
            border-top-left-radius: 20px; /* Match container border radius */
            border-top-right-radius: 20px; /* Match container border radius */
        }
        #calculator .display::-webkit-scrollbar {
            height: 6px;
        }
        #calculator .display::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 3px;
        }
        #calculator .display::-webkit-scrollbar-track {
            background-color: transparent;
        }

        #calculator .buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4 equal columns */
            grid-template-rows: repeat(5, 1fr); /* 5 equal rows */
            gap: 1px; /* Subtle grid lines */
            flex-grow: 1;
            background-color: var(--calc-border); /* Grid lines color */
            padding-top: 1px; /* Top padding for grid lines */
        }

        #calculator .button {
            background-color: var(--calc-btn-bg);
            color: var(--calc-display-text);
            border: none;
            font-size: 1.8em; /* Larger button text */
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            user-select: none; /* Prevent text selection */
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }

        #calculator .button:hover {
            background-color: var(--calc-btn-hover);
        }

        #calculator .button.operator {
            background-color: var(--calc-btn-operator-bg);
        }

        #calculator .button.operator:hover {
            background-color: var(--calc-btn-operator-hover);
        }

        #calculator .button.clear-btn,
        #calculator .button.plus-minus,
        #calculator .button.percentage {
            background-color: var(--calc-btn-clear-bg);
        }

        #calculator .button.clear-btn:hover,
        #calculator .button.plus-minus:hover,
        #calculator .button.percentage:hover {
            background-color: var(--calc-btn-clear-hover);
        }

        #calculator .button.zero {
            grid-column: span 2; /* Make zero button span two columns */
            border-bottom-left-radius: 19px; /* Rounded corners for the actual buttons */
        }
        #calculator .button:nth-child(4n) { /* Rightmost buttons */
            border-bottom-right-radius: 0;
        }
        #calculator .button:nth-last-child(1) { /* Equal button */
            border-bottom-right-radius: 19px;
        }


        /* Scratchpad Specific Styles */
        #scratchpad-tool {
            width: 400px;
            height: 300px;
            min-width: 300px;
            min-height: 200px;
            resize: both; /* Allow resizing in all directions */
            display: flex;
            flex-direction: column;
            border-radius: var(--border-radius);
            background-color: var(--scratchpad-bg);
            border: 1px solid var(--scratchpad-border);
        }
        #scratchpad-tool .floating-tool-header {
            background-color: var(--primary-color);
            border-bottom: 1px solid var(--primary-dark);
        }
        body.dark-mode #scratchpad-tool .floating-tool-header {
            background-color: var(--primary-color);
            border-bottom: 1px solid var(--primary-dark);
        }
        #scratchpad-textarea {
            width: 100%;
            flex-grow: 1;
            border: none;
            padding: 15px;
            font-size: 1em;
            font-family: 'Poppins', sans-serif;
            resize: none; /* Handled by parent container */
            outline: none;
            background-color: var(--scratchpad-bg);
            color: var(--text-color);
            line-height: 1.6;
            tab-size: 4;
            -moz-tab-size: 4;
            white-space: pre-wrap; /* Ensure wrapping */
            word-wrap: break-word; /* Break long words */
        }
        #scratchpad-textarea::placeholder {
            color: var(--light-text-color);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .page-header, .test-header, .test-footer {
                padding: 15px 20px;
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            .page-header h1 {
                font-size: 1.1em;
            }
            .mode-toggle {
                position: absolute;
                top: 10px;
                right: 10px;
                padding: 5px;
                font-size: 1.4em;
            }
            #question-counter, #timer {
                font-size: 1em;
                padding: 8px 15px;
                min-width: unset;
                width: 100%;
            }
            .container {
                margin: 15px auto;
                border-radius: 8px;
            }
            .screen {
                padding: 25px;
            }
            .screen h2 {
                font-size: 1.8em;
                margin-bottom: 20px;
            }
            .screen p, #instructions-screen ul li {
                font-size: 0.95em;
            }
            #question-container {
                font-size: 1.2em;
                margin-bottom: 25px;
            }
            .option {
                padding: 12px 18px;
                font-size: 1em;
            }
            .btn {
                width: 100%;
                margin-bottom: 10px;
                padding: 12px 25px;
                font-size: 1em;
            }
            .test-footer .left-controls, .test-footer .right-controls {
                flex-direction: column;
                width: 100%;
                gap: 10px;
            }
            .jump-to-question {
                width: 100%;
                justify-content: center;
            }
            #question-palette {
                grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
                gap: 8px;
                padding: 15px;
            }
            .palette-btn {
                width: 45px;
                height: 45px;
                font-size: 0.9em;
            }
            #result-screen {
                padding: 25px;
            }
            #result-summary {
                padding: 20px;
            }
            .score-circle {
                width: 140px;
                height: 140px;
                margin-bottom: 20px;
            }
            .score-circle span:first-child {
                font-size: 3em;
            }
            .score-circle span:last-child {
                font-size: 1em;
            }
            .score-details {
                flex-direction: column;
                gap: 15px;
            }
            .score-details div {
                flex-basis: 100%;
            }
            .modal-content {
                padding: 30px 20px;
            }
            .modal-content h3 {
                font-size: 1.5em;
            }
            .modal-content p {
                font-size: 1em;
            }
            .modal-buttons {
                flex-direction: column;
                gap: 10px;
            }
            .floating-tool-trigger {
                width: 48px;
                height: 48px;
                font-size: 1.5em;
                bottom: 15px;
                right: 15px;
            }
            #calculator-tool, #scratchpad-tool {
                width: 95%; /* Make them wider on small screens */
                max-width: 320px; /* Limit calculator width */
                height: auto; /* Allow height to adjust */
                max-height: 90vh; /* Prevent it from exceeding screen height */
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            }
            #calculator .display {
                font-size: 2.5em; /* Adjust display font size for calculator */
                padding: 15px;
            }
            #calculator .button {
                font-size: 1.5em; /* Adjust button font size for calculator */
            }
        }

        @media (max-width: 480px) {
            .page-header {
                padding-top: 50px; /* Make space for absolute toggle */
            }
        }
    </style>
</head>
<body>
    <header class="page-header">
        <h1>IBA Graduation Mock Test</h1>
        <div class="mode-toggle" id="mode-toggle" title="Toggle Dark/Light Mode">
            <i class="fas fa-moon"></i>
        </div>
    </header>

    <main class="container">
        <section id="password-screen" class="screen">
            <h2>Enter Password to Start</h2>
            <p>Please enter the provided password to begin your mock test. This ensures the integrity of the test environment.</p>
            <div class="input-group">
                <input type="password" id="password-input" placeholder="Enter password">
                <span class="toggle-password" id="toggle-password">
                    <i class="fas fa-eye"></i>
                </span>
            </div>
            <button class="btn btn-primary" id="start-button">Start Test</button>
        </section>

        <section id="instructions-screen" class="screen hidden">
            <h2>Instructions</h2>
            <ul>
                <li>The test consists of <strong>80 Multiple Choice Questions (MCQs)</strong> across various sections.</li>
                <li>You have <strong>60 minutes (1 hour)</strong> to complete the test. The timer will start once you begin.</li>
                <li>Each question has only <strong>one correct answer</strong>.</li>
                <li>You can navigate between questions using the "Previous" and "Next" buttons, or by using the question palette at the bottom.</li>
                <li>You can "Flag" questions for review and come back to them later.</li>
                <li>Your progress (answered, not answered, flagged) will be visible in the question palette.</li>
                <li>A calculator and a scratchpad are available as floating tools for your convenience.</li>
                <li>Once you click "Submit Test," you will not be able to change your answers.</li>
                <li>Ensure you have a stable internet connection.</li>
                <li>Good luck!</li>
            </ul>
            <button class="btn btn-primary" id="begin-test-button">Begin Test</button>
        </section>

        <section id="test-screen" class="hidden">
            <div class="test-header">
                <div id="question-counter">Question: 1 / 80</div>
                <div id="timer">Time Left: 60:00</div>
                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
            </div>

            <div class="test-body">
                <div class="reading-passage hidden" id="reading-passage-container">
                    <h3>Reading Passage:</h3>
                    <p id="reading-passage-content"></p>
                </div>
                <p id="question-container"></p>
                <div class="options-container" id="options-container">
                    </div>
            </div>

            <div class="test-footer">
                <div class="left-controls">
                    <button class="btn btn-secondary" id="prev-button"><i class="fas fa-arrow-left"></i> Previous</button>
                    <button class="btn btn-secondary" id="next-button">Next <i class="fas fa-arrow-right"></i></button>
                </div>
                <div class="jump-to-question">
                    Jump to:
                    <select id="jump-select"></select>
                </div>
                <div class="right-controls">
                    <button class="btn btn-flag" id="flag-button"><i class="fas fa-flag"></i> Flag for Review</button>
                    <button class="btn btn-primary" id="submit-test-button">Submit Test <i class="fas fa-check"></i></button>
                </div>
            </div>

            <div class="question-palette" id="question-palette">
                </div>
        </section>

        <section id="result-screen" class="screen hidden">
            <h2>Test Results</h2>
            <div id="result-summary">
                <div class="score-circle">
                    <span id="final-score">0</span>
                    <span>/ 80 Marks</span>
                </div>
                <div class="score-details">
                    <div>
                        <p>Total Questions</p>
                        <p id="total-questions-summary">80</p>
                    </div>
                    <div>
                        <p>Attempted Questions</p>
                        <p id="attempted-questions-summary">0</p>
                    </div>
                    <div>
                        <p>Correct Answers</p>
                        <p id="correct-answers-summary">0</p>
                    </div>
                    <div>
                        <p>Incorrect Answers</p>
                        <p id="incorrect-answers-summary">0</p>
                    </div>
                </div>
            </div>
            <div class="controls">
                <button class="btn btn-secondary" id="review-answers-button"><i class="fas fa-eye"></i> Review Answers</button>
                <button class="btn btn-primary" id="download-pdf-button"><i class="fas fa-file-pdf"></i> Download PDF</button>
                <button class="btn btn-secondary" id="retake-test-button"><i class="fas fa-redo"></i> Retake Test</button>
            </div>

            <div id="answer-review-container" class="hidden" style="width: 100%; text-align: left; margin-top: 30px;">
                </div>
        </section>
    </main>

    <footer class="page-footer">
        <p>&copy; 2025 IBA Mock Test. All rights reserved.</p>
    </footer>

    <div id="confirm-submit-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Confirm Submission</h3>
            <p>Are you sure you want to submit the test? You will not be able to change your answers after submission.</p>
            <div class="modal-buttons">
                <button class="btn btn-danger" id="confirm-submit-yes">Yes, Submit</button>
                <button class="btn btn-secondary" id="confirm-submit-no">No, Go Back</button>
            </div>
        </div>
    </div>

    <div id="review-summary-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Test Summary</h3>
            <div class="summary-grid">
                <div class="summary-item answered">
                    <strong id="summary-answered-count">0</strong>
                    <span>Answered</span>
                </div>
                <div class="summary-item not-answered">
                    <strong id="summary-not-answered-count">0</strong>
                    <span>Not Answered</span>
                </div>
                <div class="summary-item flagged">
                    <strong id="summary-flagged-count">0</strong>
                    <span>Flagged</span>
                </div>
            </div>
            <p>You have <span id="unanswered-flagged-message"></span></p>
            <div class="modal-buttons">
                <button class="btn btn-primary" id="summary-continue-test">Continue Test</button>
                <button class="btn btn-danger" id="summary-submit-test">Submit Anyway</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
        <p>Generating PDF...</p>
    </div>

    <div class="floating-tool-trigger" id="calculator-trigger" title="Open Calculator">
        <i class="fas fa-calculator"></i>
    </div>
    <div class="floating-tool-trigger" id="scratchpad-trigger" style="bottom: 85px;" title="Open Scratchpad">
        <i class="fas fa-pencil-alt"></i>
    </div>

    <div class="floating-tool-container hidden" id="calculator-tool">
        <div class="floating-tool-header">
            <span>Calculator</span>
            <button class="close-btn" data-tool="calculator"><i class="fas fa-times"></i></button>
        </div>
        <div id="calculator">
            <div class="display" id="calculator-display">0</div>
            <div class="buttons">
                <button class="button clear-btn">AC</button>
                <button class="button plus-minus">±</button>
                <button class="button percentage">%</button>
                <button class="button operator">÷</button>
                <button class="button">7</button>
                <button class="button">8</button>
                <button class="button">9</button>
                <button class="button operator">×</button>
                <button class="button">4</button>
                <button class="button">5</button>
                <button class="button">6</button>
                <button class="button operator">-</button>
                <button class="button">1</button>
                <button class="button">2</button>
                <button class="button">3</button>
                <button class="button operator">+</button>
                <button class="button zero">0</button>
                <button class="button decimal">.</button>
                <button class="button operator equal">=</button>
            </div>
        </div>
    </div>

    <div class="floating-tool-container hidden" id="scratchpad-tool">
        <div class="floating-tool-header">
            <span>Scratchpad</span>
            <button class="close-btn" data-tool="scratchpad"><i class="fas fa-times"></i></button>
        </div>
        <textarea id="scratchpad-textarea" placeholder="Write your notes here..."></textarea>
    </div>

    <script>
        const PASSWORD = "ibacompletemocktest"; // Simple password for demonstration

       const quizData = [
  // Section 1: English (40 Marks)

  // English - Reading Comprehension (10 Questions) for Q1-Q10
  {
    question: "What is the main topic of the passage?",
    passage: "Climate change refers to long-term alterations in temperature, precipitation, wind patterns, and other elements of the Earth's climate system. Human activities, especially the burning of fossil fuels and deforestation, have accelerated these changes. The consequences of climate change include rising sea levels, more frequent extreme weather events, and biodiversity loss. Global efforts like the Paris Agreement aim to mitigate these effects through emission reductions and sustainable development.",
    options: ["Weather forecasting", "Climate change", "Earth's oceans", "Fossil fuels"],
    correctAnswer: 1
  },
  {
    question: "According to the passage, which of the following is NOT an element of Earth's climate system mentioned in relation to long-term alterations?",
    options: ["Temperature", "Wind patterns", "Ocean currents", "Precipitation"],
    correctAnswer: 2
  },
  {
    question: "What are the two main human activities mentioned that accelerate climate change?",
    options: ["Reforestation and recycling", "Burning fossil fuels and deforestation", "Solar panel installation and wind energy", "Urbanization and agriculture"],
    correctAnswer: 1
  },
  {
    question: "Which of these is a consequence of climate change mentioned in the passage?",
    options: ["Decreasing sea levels", "Less frequent extreme weather", "Biodiversity gain", "Rising sea levels"],
    correctAnswer: 3
  },
  {
    question: "What global effort is mentioned as aiming to mitigate climate change effects?",
    options: ["Kyoto Protocol", "Paris Agreement", "Geneva Convention", "Stockholm Accord"],
    correctAnswer: 1
  },
  {
    question: "How do global efforts aim to mitigate climate change effects?",
    options: ["By increasing deforestation", "Through emission reductions and sustainable development", "By promoting fossil fuel use", "By ignoring weather patterns"],
    correctAnswer: 1
  },
  {
    question: "The term 'mitigate' in the passage most closely means:",
    options: ["Intensify", "Worsen", "Lessen or reduce", "Create"],
    correctAnswer: 2
  },
  {
    question: "'Biodiversity loss' refers to:",
    options: ["An increase in different species", "The reduction or disappearance of various species", "A change in weather patterns", "The growth of new forests"],
    correctAnswer: 1
  },
  {
    question: "What are 'fossil fuels' primarily responsible for accelerating, as per the passage?",
    options: ["Ocean currents", "Climate system alterations", "Animal migration", "Cloud formation"],
    correctAnswer: 1
  },
  {
    question: "The passage suggests that climate change is a ________ issue.",
    options: ["Temporary", "Local", "Long-term", "Minor"],
    correctAnswer: 2
  },

  // English - Vocabulary (10 Questions)
  {
    question: "Synonym of 'Rapid':",
    options: ["Slow", "Quick", "Lazy", "Gentle"],
    correctAnswer: 1
  },
  {
    question: "Antonym of 'Generous':",
    options: ["Kind", "Rich", "Mean", "Honest"],
    correctAnswer: 2
  },
  {
    question: "Correct spelling:",
    options: ["Receeve", "Receive", "Recieve", "Recive"],
    correctAnswer: 1
  },
  {
    question: "Synonym of 'Abandon':",
    options: ["Leave", "Enter", "Stay", "Continue"],
    correctAnswer: 0
  },
  {
    question: "Antonym of 'Harsh':",
    options: ["Cold", "Rough", "Gentle", "Bitter"],
    correctAnswer: 2
  },
  {
    question: "Correct spelling:",
    options: ["Accomodation", "Accommodation", "Acommodation", "Accomadation"],
    correctAnswer: 1
  },
  {
    question: "Synonym of 'Brief':",
    options: ["Long", "Short", "Detailed", "Slow"],
    correctAnswer: 1
  },
  {
    question: "Antonym of 'Permanent':",
    options: ["Lasting", "Constant", "Temporary", "Firm"],
    correctAnswer: 2
  },
  {
    question: "Correct spelling:",
    options: ["Enviroment", "Environment", "Envirenment", "Environmant"],
    correctAnswer: 1
  },
  {
    question: "Antonym of 'Success':",
    options: ["Win", "Victory", "Triumph", "Failure"],
    correctAnswer: 3
  },

  // English - Grammar (10 Questions)
  {
    question: "Identify the error: 'He go to school every day.'",
    options: ["He", "Go", "School", "Day"],
    correctAnswer: 1
  },
  {
    question: "Fill in the blank: 'He is fond ___ music.'",
    options: ["with", "for", "of", "at"],
    correctAnswer: 2
  },
  {
    question: "Choose the correct sentence:",
    options: ["She do her homework regularly.", "She does her homework regularly.", "She did her homework regularly.", "She done her homework regularly."],
    correctAnswer: 1
  },
  {
    question: "Identify the error: 'They has arrived late.'",
    options: ["They", "Has", "Arrived", "Late"],
    correctAnswer: 1
  },
  {
    question: "Fill in the blank: 'The cat jumped ___ the table.'",
    options: ["in", "on", "for", "by"],
    correctAnswer: 1
  },
  {
    question: "Choose the correct sentence:",
    options: ["I have went to market.", "I gone to market.", "I have gone to market.", "I go to market."],
    correctAnswer: 2
  },
  {
    question: "Identify the error: 'She playing guitar now.'",
    options: ["She", "Playing", "Guitar", "Now"],
    correctAnswer: 1
  },
  {
    question: "Fill in the blank: 'Ali is good ___ mathematics.'",
    options: ["at", "in", "on", "for"],
    correctAnswer: 0
  },
  {
    question: "Choose the correct sentence:",
    options: ["They is eating dinner.", "They are eating dinner.", "They eating dinner.", "They eat dinner now."],
    correctAnswer: 1
  },
  {
    question: "Identify the error: 'My brother don't like coffee.'",
    options: ["My", "Brother", "Don’t", "Like"],
    correctAnswer: 2
  },

  // English - Vocabulary: Spell Checking (10 Questions)
  {
    question: "Choose the correct spelling:",
    options: ["Accomodate", "Acommodate", "Accommodate", "Acomodate"],
    correctAnswer: 2
  },
  {
    question: "Choose the correct spelling:",
    options: ["Definately", "Definitely", "Defanitely", "Definitley"],
    correctAnswer: 1
  },
  {
    question: "Choose the correct spelling:",
    options: ["Neccessary", "Necessary", "Necesary", "Neccesary"],
    correctAnswer: 1
  },
  {
    question: "Choose the correct spelling:",
    options: ["Tommorrow", "Tomorow", "Tomorrow", "Tommorow"],
    correctAnswer: 2
  },
  {
    question: "Choose the correct spelling:",
    options: ["Goverment", "Goverrnment", "Government", "Govenment"],
    correctAnswer: 2
  },
  {
    question: "Choose the correct spelling:",
    options: ["Begining", "Beginning", "Beggining", "Begininng"],
    correctAnswer: 1
  },
  {
    question: "Choose the correct spelling:",
    options: ["Febuary", "February", "Februery", "Febraury"],
    correctAnswer: 1
  },
  {
    question: "Choose the correct spelling:",
    options: ["Occurence", "Occurance", "Occurrence", "Ocurrence"],
    correctAnswer: 2
  },
  {
    question: "Choose the correct spelling:",
    options: ["Seperate", "Separate", "Seperete", "Seperat"],
    correctAnswer: 1
  },
  {
    question: "Choose the correct spelling:",
    options: ["Reccommend", "Recommend", "Recomend", "Recommmend"],
    correctAnswer: 1
  },

  // Mathematics (20 Questions)
  {
    question: "12 + 15 =",
    options: ["25", "27", "28", "29"],
    correctAnswer: 1
  },
  {
    question: "5 × 6 =",
    options: ["25", "30", "36", "35"],
    correctAnswer: 1
  },
  {
    question: "100 ÷ 4 =",
    options: ["20", "24", "25", "26"],
    correctAnswer: 2
  },
  {
    question: "45 – 18 =",
    options: ["26", "27", "28", "29"],
    correctAnswer: 1
  },
  {
    question: "10% of 200 is:",
    options: ["10", "20", "30", "40"],
    correctAnswer: 1
  },
  {
    question: "If a pen costs Rs. 20, how many can you buy with Rs. 100?",
    options: ["3", "4", "5", "6"],
    correctAnswer: 2
  },
  {
    question: "Solve: 7 × 8 =",
    options: ["54", "56", "58", "60"],
    correctAnswer: 1
  },
  {
    question: "If Ali is 5 years older than Sara and Sara is 15, what is Ali’s age?",
    options: ["20", "21", "22", "19"],
    correctAnswer: 0
  },
  {
    question: "Find the missing number: 2, 4, __, 8",
    options: ["5", "6", "7", "9"],
    correctAnswer: 1
  },
  {
    question: "90 ÷ 9 =",
    options: ["10", "9", "8", "11"],
    correctAnswer: 0
  },
  {
    question: "Square of 6 is:",
    options: ["36", "12", "18", "30"],
    correctAnswer: 0
  },
  {
    question: "What is 15% of 100?",
    options: ["5", "10", "15", "20"],
    correctAnswer: 2
  },
  {
    question: "What is 9²?",
    options: ["81", "72", "90", "99"],
    correctAnswer: 0
  },
  {
    question: "What is 50 + 25 – 10?",
    options: ["55", "65", "75", "85"],
    correctAnswer: 0
  },
  {
    question: "What is 100 – 55?",
    options: ["55", "45", "35", "50"],
    correctAnswer: 1
  },
  {
    question: "What is 8 × 7?",
    options: ["56", "64", "72", "70"],
    correctAnswer: 0
  },
  {
    question: "If a car travels 60 km in 1 hour, how far will it travel in 3 hours?",
    options: ["120 km", "180 km", "200 km", "150 km"],
    correctAnswer: 1
  },
  {
    question: "What is ⅓ of 90?",
    options: ["20", "25", "30", "40"],
    correctAnswer: 2
  },
  {
    question: "Divide 144 by 12:",
    options: ["10", "12", "14", "16"],
    correctAnswer: 1
  },
  {
    question: "If x = 5, what is the value of 2x + 3?",
    options: ["10", "11", "13", "15"],
    correctAnswer: 2
  },

  // General Knowledge (30 Questions - Computer section removed)

  // Current Affairs / World Knowledge (15 Questions)
  {
    question: "Who is the current Secretary General of the United Nations (2025)?",
    options: ["António Guterres", "Ban Ki-moon", "Kofi Annan", "Tedros Adhanom"],
    correctAnswer: 0
  },
  {
    question: "COP28 Climate Summit 2023 was held in:",
    options: ["Paris", "Dubai", "London", "Geneva"],
    correctAnswer: 1
  },
  {
    question: "Which country hosted the 2024 Olympic Games?",
    options: ["Japan", "USA", "France", "China"],
    correctAnswer: 2
  },
  {
    question: "The currency of Turkey is:",
    options: ["Riyal", "Euro", "Lira", "Dinar"],
    correctAnswer: 2
  },
  {
    question: "The capital of Canada is:",
    options: ["Toronto", "Vancouver", "Ottawa", "Montreal"],
    correctAnswer: 2
  },
  {
    question: "Pakistan's current Chief of Army Staff (2025):",
    options: ["Gen. Bajwa", "Gen. Munir", "Gen. Raheel", "Gen. Kayani"],
    correctAnswer: 1
  },
  {
    question: "The United Nations was formed in:",
    options: ["1942", "1945", "1950", "1947"],
    correctAnswer: 1
  },
  {
    question: "Largest Muslim population in the world is in:",
    options: ["Pakistan", "Bangladesh", "Saudi Arabia", "Indonesia"],
    correctAnswer: 3
  },
  {
    question: "The OIC stands for:",
    options: ["Organization of Islamic Countries", "Office of International Council", "Organization of International Culture", "Overseas Islamic Committee"],
    correctAnswer: 0
  },
  {
    question: "CPEC is a joint venture between Pakistan and:",
    options: ["USA", "Saudi Arabia", "China", "Russia"],
    correctAnswer: 2
  },
  {
    question: "World War II ended in:",
    options: ["1943", "1944", "1945", "1946"],
    correctAnswer: 2
  },
  {
    question: "Who is the current Prime Minister of the UK (2025)?",
    options: ["Rishi Sunak", "Boris Johnson", "Theresa May", "Keir Starmer"],
    correctAnswer: 0
  },
  {
    question: "First woman Prime Minister of Pakistan was:",
    options: ["Fatima Jinnah", "Hina Rabbani Khar", "Benazir Bhutto", "Maryam Nawaz"],
    correctAnswer: 2
  },
  {
    question: "UNO headquarters is in:",
    options: ["Paris", "New York", "London", "Geneva"],
    correctAnswer: 1
  },
  {
    question: "Current Chairman of Senate Pakistan (2025):",
    options: ["Yousuf Raza Gillani", "Shibli Faraz", "Sanjrani", "Aitzaz Ahsan"],
    correctAnswer: 0
  },

  // Everyday Science (10 Questions)
  {
    question: "The hardest natural substance on Earth is:",
    options: ["Gold", "Iron", "Diamond", "Coal"],
    correctAnswer: 2
  },
  {
    question: "The gas used in soft drinks is:",
    options: ["Oxygen", "Nitrogen", "Carbon Dioxide", "Hydrogen"],
    correctAnswer: 2
  },
  {
    question: "The smallest unit of matter is:",
    options: ["Molecule", "Atom", "Cell", "Electron"],
    correctAnswer: 1
  },
  {
    question: "Which vitamin is produced in human skin by sunlight?",
    options: ["Vitamin A", "Vitamin B", "Vitamin C", "Vitamin D"],
    correctAnswer: 3
  },
  {
    question: "Water freezes at:",
    options: ["50°C", "0°C", "10°C", "-10°C"],
    correctAnswer: 1
  },
  {
    question: "The main source of energy for Earth is:",
    options: ["Moon", "Sun", "Wind", "Earth itself"],
    correctAnswer: 1
  },
  {
    question: "The boiling point of water is:",
    options: ["50°C", "80°C", "100°C", "120°C"],
    correctAnswer: 2
  },
  {
    question: "Human blood is red because of:",
    options: ["Chlorophyll", "Hemoglobin", "Carbon", "Iodine"],
    correctAnswer: 1
  },
  {
    question: "Instrument used to measure temperature is:",
    options: ["Barometer", "Thermometer", "Hygrometer", "Altimeter"],
    correctAnswer: 1
  },
  {
    question: "Which organ purifies blood in the human body?",
    options: ["Heart", "Lungs", "Kidneys", "Liver"],
    correctAnswer: 2
  },

  // Islamiat / Pakistan Studies (5 Questions)
  {
    question: "How many Makki Surahs are in the Holy Quran?",
    options: ["86", "114", "28", "26"],
    correctAnswer: 0
  },
  {
    question: "Pakistan came into being on:",
    options: ["15 August 1947", "14 August 1947", "23 March 1940", "11 September 1948"],
    correctAnswer: 1
  },
  {
    question: "First Constitution of Pakistan was enforced in:",
    options: ["1956", "1962", "1973", "1947"],
    correctAnswer: 0
  },
  {
    question: "Who was the first caliph of Islam?",
    options: ["Umar", "Uthman", "Ali", "Abu Bakr"],
    correctAnswer: 3
  },
  {
    question: "Founder of Pakistan was:",
    options: ["Liaquat Ali Khan", "Allama Iqbal", "Quaid-e-Azam", "Zia-ul-Haq"],
    correctAnswer: 2
  },

  // Science - Biology (10 Questions)
  {
    question: "What is the powerhouse of the cell?",
    options: ["Nucleus", "Mitochondria", "Ribosome", "Endoplasmic Reticulum"],
    correctAnswer: 1
  },
  {
    question: "What gas do plants absorb from the atmosphere?",
    options: ["Oxygen", "Nitrogen", "Carbon Dioxide", "Hydrogen"],
    correctAnswer: 2
  },
  {
    question: "Which of the following is responsible for carrying oxygen in the blood?",
    options: ["White Blood Cells", "Platelets", "Plasma", "Red Blood Cells"],
    correctAnswer: 3
  },
  {
    question: "What is the process by which plants make their own food?",
    options: ["Respiration", "Transpiration", "Photosynthesis", "Germination"],
    correctAnswer: 2
  },
  {
    question: "Which organ is responsible for pumping blood throughout the body?",
    options: ["Lungs", "Liver", "Kidneys", "Heart"],
    correctAnswer: 3
  },
  {
    question: "What is the basic unit of heredity?",
    options: ["Cell", "Tissue", "Gene", "Organ"],
    correctAnswer: 2
  },
  {
    question: "Which planet is known as the 'Red Planet'?",
    options: ["Earth", "Mars", "Jupiter", "Venus"],
    correctAnswer: 1
  },
  {
    question: "What is the largest organ in the human body?",
    options: ["Heart", "Brain", "Skin", "Liver"],
    correctAnswer: 2
  },
  {
    question: "Which animal lays eggs?",
    options: ["Dog", "Cat", "Chicken", "Cow"],
    correctAnswer: 2
  },
  {
    question: "What is the chemical symbol for water?",
    options: ["CO2", "O2", "H2O", "N2"],
    correctAnswer: 2
  }
];

        // Global variables for quiz state
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let flaggedQuestions = new Set();
        let timerInterval;
        const totalTime = 60 * 60; // 60 minutes in seconds
        let timeLeft = totalTime;

        // DOM Elements
        const passwordScreen = document.getElementById('password-screen');
        const passwordInput = document.getElementById('password-input');
        const togglePassword = document.getElementById('toggle-password');
        const startButton = document.getElementById('start-button');
        const instructionsScreen = document.getElementById('instructions-screen');
        const beginTestButton = document.getElementById('begin-test-button');
        const testScreen = document.getElementById('test-screen');
        const questionContainer = document.getElementById('question-container');
        const optionsContainer = document.getElementById('options-container');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const submitTestButton = document.getElementById('submit-test-button');
        const questionCounter = document.getElementById('question-counter');
        const timerDisplay = document.getElementById('timer');
        const progressBar = document.getElementById('progress-bar');
        const jumpSelect = document.getElementById('jump-select');
        const flagButton = document.getElementById('flag-button');
        const questionPalette = document.getElementById('question-palette');
        const resultScreen = document.getElementById('result-screen');
        const finalScoreDisplay = document.getElementById('final-score');
        const totalQuestionsSummary = document.getElementById('total-questions-summary');
        const attemptedQuestionsSummary = document.getElementById('attempted-questions-summary');
        const correctAnswersSummary = document.getElementById('correct-answers-summary');
        const incorrectAnswersSummary = document.getElementById('incorrect-answers-summary');
        const reviewAnswersButton = document.getElementById('review-answers-button');
        const downloadPdfButton = document.getElementById('download-pdf-button');
        const retakeTestButton = document.getElementById('retake-test-button');
        const answerReviewContainer = document.getElementById('answer-review-container');
        const confirmSubmitModal = document.getElementById('confirm-submit-modal');
        const confirmSubmitYes = document.getElementById('confirm-submit-yes');
        const confirmSubmitNo = document.getElementById('confirm-submit-no');
        const reviewSummaryModal = document.getElementById('review-summary-modal');
        const summaryAnsweredCount = document.getElementById('summary-answered-count');
        const summaryNotAnsweredCount = document.getElementById('summary-not-answered-count');
        const summaryFlaggedCount = document.getElementById('summary-flagged-count');
        const unansweredFlaggedMessage = document.getElementById('unanswered-flagged-message');
        const summaryContinueTest = document.getElementById('summary-continue-test');
        const summarySubmitTest = document.getElementById('summary-submit-test');
        const loadingOverlay = document.getElementById('loading-overlay');
        const modeToggle = document.getElementById('mode-toggle');

        // Calculator elements
        const calculatorTrigger = document.getElementById('calculator-trigger');
        const calculatorTool = document.getElementById('calculator-tool');
        const calculatorDisplay = document.getElementById('calculator-display');
        const calculatorButtons = document.querySelectorAll('#calculator .button');
        const closeToolButtons = document.querySelectorAll('.close-btn');

        // Scratchpad elements
        const scratchpadTrigger = document.getElementById('scratchpad-trigger');
        const scratchpadTool = document.getElementById('scratchpad-tool');
        const scratchpadTextarea = document.getElementById('scratchpad-textarea');

        // Passage for Q1-Q10 (English Reading Comprehension)
        const readingPassageContainer = document.getElementById('reading-passage-container');
        const readingPassageContent = document.getElementById('reading-passage-content');
        const READING_PASSAGE_TEXT = `
            Climate change refers to long-term alterations in temperature, precipitation, wind patterns, and other elements of the Earth's climate system. Human activities, especially the burning of fossil fuels and deforestation, have accelerated these changes. The consequences of climate change include rising sea levels, more frequent extreme weather events, and biodiversity loss. Global efforts like the Paris Agreement aim to mitigate these effects through emission reductions and sustainable development.
        `;

        // Initialize userAnswers array and populate jump select options
        function initializeQuiz() {
            userAnswers = new Array(quizData.length).fill(null);
            flaggedQuestions = new Set();
            currentQuestionIndex = 0;
            timeLeft = totalTime; // Reset timer

            populateJumpSelect();
            renderQuestion();
            updatePalette();
            resetTimerDisplay();
            progressBar.style.width = '0%'; // Reset progress bar
            timerDisplay.classList.remove('time-low'); // Remove time-low class
        }

        function populateJumpSelect() {
            jumpSelect.innerHTML = ''; // Clear previous options
            for (let i = 0; i < quizData.length; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Question ${i + 1}`;
                jumpSelect.appendChild(option);
            }
            jumpSelect.value = currentQuestionIndex;
        }

        function renderQuestion() {
            const question = quizData[currentQuestionIndex];
            questionContainer.textContent = `Q${currentQuestionIndex + 1}: ${question.question}`;
            optionsContainer.innerHTML = ''; // Clear previous options

            // Show/hide reading passage based on question index
            if (currentQuestionIndex >= 0 && currentQuestionIndex <= 9) { // Q1-Q10 for reading comprehension
                readingPassageContainer.classList.remove('hidden');
                readingPassageContent.textContent = READING_PASSAGE_TEXT;
            } else {
                readingPassageContainer.classList.add('hidden');
                readingPassageContent.textContent = '';
            }


            question.options.forEach((optionText, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.classList.add('option');
                optionDiv.textContent = optionText;
                optionDiv.dataset.index = index;
                if (userAnswers[currentQuestionIndex] === index) {
                    optionDiv.classList.add('selected');
                }
                optionDiv.addEventListener('click', () => selectOption(index));
                optionsContainer.appendChild(optionDiv);
            });

            questionCounter.textContent = `Question: ${currentQuestionIndex + 1} / ${quizData.length}`;
            jumpSelect.value = currentQuestionIndex;
            updateFlagButton();
            updatePalette();
        }

        function selectOption(selectedIndex) {
            userAnswers[currentQuestionIndex] = selectedIndex;
            renderQuestion(); // Re-render to show selection
            updatePalette();
        }

        function navigateQuestions(direction) {
            if (direction === 'next' && currentQuestionIndex < quizData.length - 1) {
                currentQuestionIndex++;
            } else if (direction === 'prev' && currentQuestionIndex > 0) {
                currentQuestionIndex--;
            }
            renderQuestion();
        }

        function jumpToQuestion() {
            currentQuestionIndex = parseInt(jumpSelect.value);
            renderQuestion();
        }

        function toggleFlag() {
            if (flaggedQuestions.has(currentQuestionIndex)) {
                flaggedQuestions.delete(currentQuestionIndex);
            } else {
                flaggedQuestions.add(currentQuestionIndex);
            }
            updateFlagButton();
            updatePalette();
        }

        function updateFlagButton() {
            if (flaggedQuestions.has(currentQuestionIndex)) {
                flagButton.classList.add('flagged');
                flagButton.innerHTML = '<i class="fas fa-flag"></i> Flagged';
            } else {
                flagButton.classList.remove('flagged');
                flagButton.innerHTML = '<i class="fas fa-flag"></i> Flag for Review';
            }
        }

        function updatePalette() {
            questionPalette.innerHTML = '';
            quizData.forEach((_, index) => {
                const paletteBtn = document.createElement('button');
                paletteBtn.classList.add('palette-btn');
                paletteBtn.textContent = index + 1;
                if (index === currentQuestionIndex) {
                    paletteBtn.classList.add('current');
                }
                if (userAnswers[index] !== null) {
                    paletteBtn.classList.add('answered');
                }
                if (flaggedQuestions.has(index)) {
                    paletteBtn.classList.add('flagged');
                } else if (userAnswers[index] === null) {
                    paletteBtn.classList.add('not-answered');
                }
                paletteBtn.addEventListener('click', () => {
                    currentQuestionIndex = index;
                    renderQuestion();
                });
                questionPalette.appendChild(paletteBtn);
            });
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                updateProgressBar();

                if (timeLeft <= 300 && !timerDisplay.classList.contains('time-low')) { // 5 minutes warning
                    timerDisplay.classList.add('time-low');
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerDisplay.textContent = "Time's Up!";
                    handleSubmitTest(true); // Automatically submit when time runs out
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.textContent = `Time Left: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function resetTimerDisplay() {
            const minutes = Math.floor(totalTime / 60);
            const seconds = totalTime % 60;
            timerDisplay.textContent = `Time Left: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function updateProgressBar() {
            const progress = ((totalTime - timeLeft) / totalTime) * 100;
            progressBar.style.width = `${progress}%`;
        }

        function calculateResults() {
            let correctCount = 0;
            let attemptedCount = 0;

            userAnswers.forEach((answer, index) => {
                if (answer !== null) {
                    attemptedCount++;
                    if (answer === quizData[index].correctAnswer) {
                        correctCount++;
                    }
                }
            });

            return {
                correct: correctCount,
                attempted: attemptedCount,
                incorrect: attemptedCount - correctCount,
                total: quizData.length
            };
        }

        function showResultScreen(results) {
            testScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');
            clearInterval(timerInterval); // Stop the timer

            finalScoreDisplay.textContent = results.correct;
            totalQuestionsSummary.textContent = results.total;
            attemptedQuestionsSummary.textContent = results.attempted;
            correctAnswersSummary.textContent = results.correct;
            incorrectAnswersSummary.textContent = results.incorrect;

            // Save results to local storage for retake/review persistence if needed
            localStorage.setItem('lastQuizResults', JSON.stringify({ userAnswers, flaggedQuestions, results }));
        }

        function reviewAnswers() {
            answerReviewContainer.innerHTML = '';
            answerReviewContainer.classList.remove('hidden'); // Ensure it's visible

            quizData.forEach((question, index) => {
                const qDiv = document.createElement('div');
                qDiv.classList.add('result-question');

                const qText = document.createElement('p');
                qText.textContent = `Q${index + 1}: ${question.question}`;
                qDiv.appendChild(qText);

                question.options.forEach((option, optionIndex) => {
                    const optionP = document.createElement('p');
                    optionP.classList.add('result-option');
                    optionP.textContent = `${String.fromCharCode(65 + optionIndex)}. ${option}`; // A, B, C, D

                    if (optionIndex === question.correctAnswer) {
                        optionP.classList.add('correct');
                        optionP.textContent += ' (Correct Answer)';
                    }

                    if (userAnswers[index] === optionIndex) {
                        optionP.classList.add('user-answer');
                        if (userAnswers[index] === question.correctAnswer) {
                            optionP.classList.add('correct');
                        } else {
                            optionP.classList.add('incorrect');
                        }
                    }
                    qDiv.appendChild(optionP);
                });

                if (userAnswers[index] === null) {
                    const notAttemptedP = document.createElement('p');
                    notAttemptedP.classList.add('not-attempted-text');
                    notAttemptedP.textContent = 'Not Attempted';
                    qDiv.appendChild(notAttemptedP);
                }

                answerReviewContainer.appendChild(qDiv);
            });
            reviewAnswersButton.classList.add('hidden'); // Hide review button after showing
            downloadPdfButton.classList.add('hidden'); // Hide download button as well for clarity
            // Scroll to the review section
            answerReviewContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }


        function downloadQuizAsPdf() {
            loadingOverlay.classList.remove('hidden'); // Show loading spinner
            const element = document.getElementById('result-screen');

            // Temporarily hide buttons and other non-content elements for PDF generation
            const controls = element.querySelector('.controls');
            if (controls) controls.classList.add('hidden');
            // Show review container if not already visible
            if (answerReviewContainer.classList.contains('hidden')) {
                reviewAnswers(); // Generate review content if not already
            }


            // Scroll to top of results before PDF to capture full content
            resultScreen.scrollTo(0, 0);


            const opt = {
                margin: 0.5,
                filename: 'IBA_Mock_Test_Results.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().finally(() => {
                loadingOverlay.classList.add('hidden'); // Hide loading spinner
                if (controls) controls.classList.remove('hidden');
                // Don't hide answerReviewContainer, keep it visible for user
            });
        }


        // Event Listeners
        startButton.addEventListener('click', () => {
            if (passwordInput.value === PASSWORD) {
                passwordScreen.classList.add('hidden');
                instructionsScreen.classList.remove('hidden');
            } else {
                alert('Incorrect password. Please try again.');
                passwordInput.value = '';
            }
        });

        togglePassword.addEventListener('click', () => {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            togglePassword.querySelector('i').classList.toggle('fa-eye');
            togglePassword.querySelector('i').classList.toggle('fa-eye-slash');
        });


        beginTestButton.addEventListener('click', () => {
            instructionsScreen.classList.add('hidden');
            testScreen.classList.remove('hidden');
            initializeQuiz();
            startTimer();
            loadScratchpadContent(); // Load saved scratchpad content
        });

        prevButton.addEventListener('click', () => navigateQuestions('prev'));
        nextButton.addEventListener('click', () => navigateQuestions('next'));
        jumpSelect.addEventListener('change', jumpToQuestion);
        flagButton.addEventListener('click', toggleFlag);


        submitTestButton.addEventListener('click', () => {
            const answeredCount = userAnswers.filter(answer => answer !== null).length;
            const notAnsweredCount = quizData.length - answeredCount;
            const flaggedCount = flaggedQuestions.size;

            summaryAnsweredCount.textContent = answeredCount;
            summaryNotAnsweredCount.textContent = notAnsweredCount;
            summaryFlaggedCount.textContent = flaggedCount;

            if (notAnsweredCount > 0 || flaggedCount > 0) {
                let message = "You still have ";
                if (notAnsweredCount > 0) {
                    message += `${notAnsweredCount} unanswered questions`;
                }
                if (notAnsweredCount > 0 && flaggedCount > 0) {
                    message += " and ";
                }
                if (flaggedCount > 0) {
                    message += `${flaggedCount} flagged questions`;
                }
                message += ".";
                unansweredFlaggedMessage.textContent = message;
                reviewSummaryModal.classList.remove('hidden');
            } else {
                confirmSubmitModal.classList.remove('hidden');
            }
        });

        confirmSubmitYes.addEventListener('click', () => handleSubmitTest(false)); // Not time-triggered
        confirmSubmitNo.addEventListener('click', () => confirmSubmitModal.classList.add('hidden'));

        summaryContinueTest.addEventListener('click', () => reviewSummaryModal.classList.add('hidden'));
        summarySubmitTest.addEventListener('click', () => {
            reviewSummaryModal.classList.add('hidden');
            handleSubmitTest(false); // Not time-triggered
        });


        function handleSubmitTest(isTimeUp) {
            confirmSubmitModal.classList.add('hidden'); // Hide modal if open
            reviewSummaryModal.classList.add('hidden'); // Hide review summary modal if open

            const results = calculateResults();
            showResultScreen(results);

            if (isTimeUp) {
                alert("Time's up! Your test has been automatically submitted.");
            }
        }


        reviewAnswersButton.addEventListener('click', reviewAnswers);
        downloadPdfButton.addEventListener('click', downloadQuizAsPdf);

        retakeTestButton.addEventListener('click', () => {
            resultScreen.classList.add('hidden');
            passwordScreen.classList.remove('hidden');
            answerReviewContainer.classList.add('hidden'); // Hide review details on retake
            reviewAnswersButton.classList.remove('hidden'); // Show review button again
            downloadPdfButton.classList.remove('hidden'); // Show download button again
            passwordInput.value = ''; // Clear password field
            initializeQuiz(); // Re-initialize all quiz state
        });

        // Dark mode toggle
        modeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const icon = modeToggle.querySelector('i');
            if (document.body.classList.contains('dark-mode')) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
                localStorage.setItem('darkMode', 'enabled');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
                localStorage.setItem('darkMode', 'disabled');
            }
        });

        // Apply dark mode preference on load
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.body.classList.add('dark-mode');
            modeToggle.querySelector('i').classList.remove('fa-moon');
            modeToggle.querySelector('i').classList.add('fa-sun');
        } else {
            document.body.classList.remove('dark-mode');
            modeToggle.querySelector('i').classList.remove('fa-sun');
            modeToggle.querySelector('i').classList.add('fa-moon');
        }


        // --- Calculator Logic ---
        const calculator = {
            displayValue: '0',
            firstOperand: null,
            waitingForSecondOperand: false,
            operator: null,
        };

        function updateDisplay() {
            calculatorDisplay.textContent = calculator.displayValue;
        }

        function inputDigit(digit) {
            const { displayValue, waitingForSecondOperand } = calculator;

            if (waitingForSecondOperand === true) {
                calculator.displayValue = digit;
                calculator.waitingForSecondOperand = false;
            } else {
                calculator.displayValue = displayValue === '0' ? digit : displayValue + digit;
            }
            updateDisplay();
        }

        function inputDecimal(dot) {
            if (calculator.waitingForSecondOperand === true) {
                calculator.displayValue = '0.';
                calculator.waitingForSecondOperand = false;
                updateDisplay();
                return;
            }
            if (!calculator.displayValue.includes(dot)) {
                calculator.displayValue += dot;
            }
            updateDisplay();
        }

        function handleOperator(nextOperator) {
            const { firstOperand, displayValue, operator } = calculator;
            const inputValue = parseFloat(displayValue);

            if (operator && calculator.waitingForSecondOperand) {
                calculator.operator = nextOperator;
                return;
            }

            if (firstOperand === null) {
                calculator.firstOperand = inputValue;
            } else if (operator) {
                const result = performCalculation[operator](firstOperand, inputValue);
                calculator.displayValue = String(parseFloat(result.toFixed(7))); // Fix for floating point precision
                calculator.firstOperand = parseFloat(calculator.displayValue);
            }

            calculator.waitingForSecondOperand = true;
            calculator.operator = nextOperator;
            updateDisplay();
        }

        function clearCalculator() {
            calculator.displayValue = '0';
            calculator.firstOperand = null;
            calculator.waitingForSecondOperand = false;
            calculator.operator = null;
            updateDisplay();
        }

        calculatorButtons.forEach(button => {
            button.addEventListener('click', event => {
                const { target } = event;

                if (!target.matches('button')) {
                    return;
                }

                if (target.classList.contains('operator')) {
                    if (target.value === '=') { // Handle equals button
                        calculateResultCalc();
                    } else {
                        handleOperator(target.textContent);
                    }
                    return;
                }

                if (target.classList.contains('decimal')) {
                    inputDecimal(target.textContent);
                    return;
                }

                if (target.classList.contains('clear-btn')) {
                    clearCalculator();
                    return;
                }

                if (target.classList.contains('percentage')) {
                    calculator.displayValue = String(parseFloat(calculator.displayValue) / 100);
                    calculator.firstOperand = null; // Reset first operand after percentage
                    calculator.waitingForSecondOperand = false; // Ready for next number input
                    updateDisplay();
                    return;
                }

                if (target.classList.contains('plus-minus')) {
                    calculator.displayValue = String(parseFloat(calculator.displayValue) * -1);
                    updateDisplay();
                    return;
                }

                inputDigit(target.textContent);
            });
        });

        const performCalculation = {
            '/': (firstOperand, secondOperand) => secondOperand === 0 ? 'Error' : firstOperand / secondOperand,
            '*': (firstOperand, secondOperand) => firstOperand * secondOperand,
            '+': (firstOperand, secondOperand) => firstOperand + secondOperand,
            '-': (firstOperand, secondOperand) => firstOperand - secondOperand,
        };

        function calculateResultCalc() {
            const inputValue = parseFloat(calculator.displayValue);

            if (calculator.firstOperand === null || calculator.operator === null || calculator.waitingForSecondOperand) {
                return;
            }

            const result = performCalculation[calculator.operator](calculator.firstOperand, inputValue);
            calculator.displayValue = String(parseFloat(result.toFixed(7))); // Fix for floating point precision
            calculator.firstOperand = null;
            calculator.operator = null;
            calculator.waitingForSecondOperand = false;
            updateDisplay();
        }

        // --- Scratchpad Logic ---
        function saveScratchpadContent() {
            localStorage.setItem('scratchpadContent', scratchpadTextarea.value);
        }

        function loadScratchpadContent() {
            const savedContent = localStorage.getItem('scratchpadContent');
            if (savedContent) {
                scratchpadTextarea.value = savedContent;
            }
        }

        // Save scratchpad content periodically or on close
        scratchpadTextarea.addEventListener('input', saveScratchpadContent);
        // Also save when the tool is closed
        closeToolButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                if (event.target.dataset.tool === 'scratchpad') {
                    saveScratchpadContent();
                    scratchpadTool.classList.add('hidden');
                } else if (event.target.dataset.tool === 'calculator') {
                    calculatorTool.classList.add('hidden');
                }
            });
        });


        // --- Floating Tools Draggable Logic ---
        function makeDraggable(element, header) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

            header.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                // get the mouse cursor position at startup:
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                // call a function whenever the cursor moves:
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                // calculate the new cursor position:
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                // set the element's new position:
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                // stop moving when mouse button is released:
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        // Make calculator and scratchpad draggable
        makeDraggable(calculatorTool, calculatorTool.querySelector('.floating-tool-header'));
        makeDraggable(scratchpadTool, scratchpadTool.querySelector('.floating-tool-header'));

        // Toggle visibility of floating tools
        calculatorTrigger.addEventListener('click', () => {
            calculatorTool.classList.toggle('hidden');
            // Ensure scratchpad is hidden if calculator is opened
            scratchpadTool.classList.add('hidden');
        });

        scratchpadTrigger.addEventListener('click', () => {
            scratchpadTool.classList.toggle('hidden');
            // Ensure calculator is hidden if scratchpad is opened
            calculatorTool.classList.add('hidden');
        });

    </script>
</body>
</html>